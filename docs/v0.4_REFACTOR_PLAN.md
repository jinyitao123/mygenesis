# Project Genesis v0.4 重构计划文档

## 1. 重构目标

将当前三层架构（Python 胶水层 + LLM 层 + 数据层）升级为**企业级五层架构**，实现：
- **业务逻辑数据化**：Action Ontology 从代码迁移到 JSON 配置
- **操作闭环模式**：Validation → Rules 执行流程
- **多模态存储**：分离事件账本(L2)与语义记忆(L3)
- **同构通用性**：Kernel 通用 + Ontology 可变 = 多应用场景

---

## 2. 架构对比

### 2.1 当前架构 (v0.3)

```
┌────────────────────────────────────────┐
│          main.py (游戏主循环)            │
└──────────────┬─────────────────────────┘
               │
┌──────────────▼─────────────────────────┐
│  LLM Engine (世界生成 + 意图解析)        │
│  - generate_world_seed()               │
│  - generate_world_skeleton()           │
│  - interpret_action()                  │
└──────────────┬─────────────────────────┘
               │
┌──────────────▼─────────────────────────┐
│  Core Modules                          │
│  - GraphClient (Neo4j CRUD)            │
│  - ActionDriver (简单规则执行)          │
│  - SimulationEngine (全局推演)          │
│  - MemoryManager (对话缓冲)             │
└──────────────┬─────────────────────────┘
               │
┌──────────────▼─────────────────────────┐
│  Data Layer                            │
│  - Neo4j (图数据库)                     │
│  - PostgreSQL + pgvector (向量库)       │
│  - Ollama (本地 LLM)                    │
└────────────────────────────────────────┘
```

**问题：**
- Action 定义在 Python 代码中，业务逻辑硬编码
- ActionDriver 缺乏 Validation → Rules 闭环
- 存储混杂（事件和记忆都在 Postgres）
- 无法支持非游戏场景（如太空站模拟）

### 2.2 目标架构 (v0.4)

```
┌─────────────────────────────────────────────────────────────┐
│                    Presentation Layer                        │
│              (Game CLI / Web Studio / API)                  │
└────────────────────┬────────────────────────────────────────┘
                       │ Intent (Natural Language)
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                     Ontology Layer                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Object Types │  │ Action Types │  │  Synapser    │      │
│  │  (Schema)    │  │   (Logic)    │  │  (NLP Map)   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                              │
│  📁 ontology/                                                │
│    ├── object_types.json      # 实体定义                    │
│    ├── action_types.json      # 动作定义 (Validation+Rules) │
│    ├── seed_data.json         # 初始数据                    │
│    └── synapser_patterns.json # 意图映射                    │
└────────────────────┬────────────────────────────────────────┘
                       │ Action Execution
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                      Kernel Layer                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Synapser   │  │Action Driver │  │ Rule Engine  │      │
│  │ Intent Parser│  │(Validation)  │  │(Side Effects)│      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐                        │
│  │ Obj Manager  │  │ Connectors   │                        │
│  │  (CRUD Ops)  │  │(Multi-Modal) │                        │
│  └──────────────┘  └──────────────┘                        │
└────────────────────┬────────────────────────────────────────┘
                       │ Query / Write
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                   Infrastructure Layer                       │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      │
│  │  Neo4j   │ │PostgreSQL│ │Victoria  │ │  File    │      │
│  │  (L1)    │ │  (L2/L3) │ │ Metrics  │ │  (L5)    │      │
│  │ State    │ │ Ledger/  │ │  (L4)    │ │ Config   │      │
│  │ Graph    │ │ Vector   │ │ Telemetry│ │          │      │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘      │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 核心改造点

### 3.1 新增：Ontology Layer (业务定义层)

**目标：** 业务规则完全数据化，零代码修改即可变更游戏规则

**新增文件：**
```
ontology/
├── object_types.json          # 实体类型定义
│   ├── Player (属性: hp, damage, location)
│   ├── NPC (属性: hp, disposition, faction)
│   ├── Location (属性: name, description)
│   └── Faction (属性: name, stance)
│
├── action_types.json          # 动作类型定义 (Palantir 模式)
│   ├── ACT_ATTACK
│   │   ├── parameters: [source_id, target_id]
│   │   ├── validation: {cypher_check}
│   │   └── rules: [modify_graph, record_event, record_telemetry]
│   ├── ACT_MOVE
│   │   ├── parameters: [agent_id, target_location]
│   │   ├── validation: {cypher_check: 检查连通性}
│   │   └── rules: [modify_graph, record_event]
│   └── ACT_TALK
│       ├── parameters: [agent_id, target_npc, content]
│       ├── validation: {always_allow}
│       └── rules: [memorize, external_log]
│
├── seed_data.json             # 初始世界数据
│   ├── 初始地点
│   ├── 初始NPC
│   └── 初始阵营关系
│
└── synapser_patterns.json     # 自然语言映射
    ├── "攻击" → ACT_ATTACK
    ├── "移动到" → ACT_MOVE
    └── "对话" → ACT_TALK
```

**示例：action_types.json**
```json
{
  "action_types": {
    "ACT_ATTACK": {
      "display_name": "攻击",
      "description": "对目标发动攻击",
      "parameters": [
        {
          "name": "source_id",
          "type": "object_ref",
          "object_type": "Player",
          "required": true
        },
        {
          "name": "target_id",
          "type": "object_ref",
          "object_type": "NPC",
          "required": true
        }
      ],
      "validation": {
        "logic_type": "cypher_check",
        "statement": "MATCH (s {id: $source_id})-[:LOCATED_AT]->(l)<-[:LOCATED_AT]-(t {id: $target_id}) RETURN count(t) > 0 as is_valid, s.name as source_name, t.name as target_name, s.damage as damage",
        "error_message": "目标必须在同一地点"
      },
      "rules": [
        {
          "type": "modify_graph",
          "description": "扣减目标HP",
          "statement": "MATCH (t {id: $target_id}) SET t.hp = t.hp - $damage"
        },
        {
          "type": "record_event",
          "description": "记录攻击事件",
          "summary_template": "{source_name} 攻击了 {target_name}"
        },
        {
          "type": "record_telemetry",
          "description": "记录伤害值",
          "entity_id": "$target_id",
          "property": "damage_taken",
          "value": "$damage"
        }
      ]
    }
  }
}
```

### 3.2 改造：Kernel Layer (通用内核层)

#### 3.2.1 ActionDriver → Palantir 操作闭环

**当前：**
```python
# 简单条件检查后直接执行
success, msg = action_driver.execute_action("TEST_ATTACK", source, target)
```

**目标：**
```python
# Validation → Rules 闭环
result = action_driver.execute("ACT_ATTACK", {
    "source_id": "player_001",
    "target_id": "npc_001"
})
# 返回: {success, validation_data, rule_reports}
```

**改造内容：**
- 添加 `_validate_object_references()` 检查对象存在性
- 添加 `_validate_action()` 执行业务规则验证
- 添加 `_validate_cypher()` Cypher 查询验证
- Rules 阶段调用 RuleEngine 路由到多模态存储

#### 3.2.2 新增：RuleEngine (规则引擎)

**职责：** 根据 rule.type 路由到不同存储后端

```python
class RuleEngine:
    def execute_rule(self, rule: dict, context: dict, action_id: str) -> dict:
        rule_type = rule.get('type')
        
        if rule_type == 'modify_graph':
            # L1: 修改当前状态 → Neo4j
            return self._execute_modify_graph(rule, context)
            
        elif rule_type == 'record_event':
            # L2: 记录事件 → PostgreSQL Event Ledger
            return self._execute_record_event(rule, context, action_id)
            
        elif rule_type == 'memorize':
            # L3: 语义记忆 → PostgreSQL + pgvector
            return self._execute_memorize(rule, context)
            
        elif rule_type == 'record_telemetry':
            # L4: 遥测数据 → VictoriaMetrics
            return self._execute_record_telemetry(rule, context)
```

#### 3.2.3 新增：Synapser (意图解析器)

**职责：** 将自然语言映射到 Action

```python
class Synapser:
    def parse_intent(self, user_input: str, context: dict) -> dict:
        """
        输入: "攻击那个僵尸"
        输出: {action_id: "ACT_ATTACK", params: {target_id: "zombie_01"}}
        """
        # 1. 使用 LLM 或模式匹配识别意图
        # 2. 实体链接 (Entity Linking)
        # 3. 参数填充
```

### 3.3 改造：Infrastructure Layer (多模态存储)

#### 3.3.1 分离 Event Ledger 和 Semantic Memory

**当前：**
- 所有数据都存 Neo4j + Postgres memories 表

**目标：**

| 存储 | 层级 | 用途 | 表/集合 |
|------|------|------|---------|
| Neo4j | L1 | 当前状态 | Nodes + Relationships |
| PostgreSQL | L2 | 事件账本 | event_ledger 表 |
| PostgreSQL + pgvector | L3 | 语义记忆 | semantic_memory 表 |
| VictoriaMetrics | L4 | 遥测数据 | metrics (未来扩展) |

**新增 SQL Schema：**

```sql
-- L2: Event Ledger (只追加，不可变)
CREATE TABLE event_ledger (
    event_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    action_type VARCHAR(64) NOT NULL,
    initiator_id VARCHAR(64) NOT NULL,
    initiator_name VARCHAR(128),
    target_id VARCHAR(64),
    target_name VARCHAR(128),
    summary TEXT,
    context JSONB,
    changes JSONB
);

-- L3: Semantic Memory (带向量)
CREATE EXTENSION IF NOT EXISTS vector;
CREATE TABLE semantic_memory (
    memory_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    entity_id VARCHAR(64),
    memory_type VARCHAR(32) NOT NULL,  -- 'dialogue', 'lore', 'event'
    content TEXT NOT NULL,
    embedding vector(768),  -- 匹配 Ollama nomic-embed-text
    importance FLOAT DEFAULT 1.0,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX idx_memory_vec ON semantic_memory USING hnsw (embedding vector_cosine_ops);
```

#### 3.3.2 Connectors 架构

```
genesis/kernel/connectors/
├── __init__.py
├── neo4j_connector.py          # L1: 当前状态
│   ├── run_query()              # Cypher 查询
│   └── run_transaction()        # 事务写入
│
├── postgres_connector.py       # L2/L3: 审计 + 记忆
│   ├── log_event()              # 写入 event_ledger
│   ├── get_history()            # 查询历史
│   ├── memorize()               # 写入 semantic_memory
│   └── search_memory()          # 向量检索
│
└── telemetry_connector.py      # L4: 遥测 (未来扩展)
    ├── push_metric()
    └── query()
```

### 3.4 改造：GraphClient → ObjectManager

**当前：**
```python
class GraphClient:
    def create_nodes_from_json()  # 批量创建节点
    def create_relationships_from_json()  # 批量创建关系
```

**目标：**
```python
class ObjectManager:
    """对象管理器 - 通用 CRUD，不关心业务含义"""
    
    def create_object(self, object_type: str, properties: dict) -> str:
        """创建对象，返回 ID"""
        
    def get_object(self, object_id: str) -> Optional[dict]:
        """获取对象"""
        
    def update_object(self, object_id: str, properties: dict) -> bool:
        """更新对象"""
        
    def delete_object(self, object_id: str) -> bool:
        """删除对象"""
        
    def create_link(self, from_id: str, to_id: str, link_type: str, properties: dict = None):
        """创建关系"""
```

---

## 4. 文件重构映射

### 4.1 文件移动/重命名

| 当前路径 | 目标路径 | 说明 |
|---------|---------|------|
| `src/core/graph_client.py` | `genesis/kernel/connectors/neo4j_connector.py` | 改为 Connector |
| `src/core/action_driver.py` | `genesis/kernel/action_driver.py` | 重写为闭环模式 |
| `src/services/vector_client.py` | `genesis/kernel/connectors/postgres_connector.py` | 扩展为 L2/L3 |
| `src/llm_engine.py` | `genesis/kernel/synapser.py` | 改为意图解析器 |
| `src/main.py` | `applications/game/main.py` | 迁移到应用层 |

### 4.2 新增文件

```
genesis/
├── __init__.py
├── kernel/
│   ├── __init__.py
│   ├── action_driver.py         # 重构：Validation→Rules闭环
│   ├── rule_engine.py           # 新增：多模态存储路由
│   ├── synapser.py              # 重构：LLM意图解析
│   ├── object_manager.py        # 新增：通用对象CRUD
│   └── connectors/
│       ├── __init__.py
│       ├── neo4j_connector.py   # 从 graph_client 重构
│       └── postgres_connector.py # 从 vector_client 扩展
│
├── ontology/
│   ├── __init__.py
│   └── loader.py                # 新增：Ontology JSON 加载器
│
└── runtime/
    ├── __init__.py
    └── bootstrapper.py          # 新增：系统初始化引导

ontology/                          # 新增：业务定义目录
├── object_types.json
├── action_types.json
├── seed_data.json
└── synapser_patterns.json

applications/
└── game/                          # 游戏应用
    ├── main.py                    # 从 src/main.py 迁移
    ├── cli.py                     # 新增：命令行界面
    └── ontology/                  # 游戏特定的 Ontology
        ├── object_types.json
        └── action_types.json
```

---

## 5. 数据迁移策略

### 5.1 Neo4j 数据无需迁移
- 当前节点/关系结构基本不变
- 仅需调整 Label 名称（如 `:Player` → `:player` 小写）

### 5.2 Postgres 数据迁移
```sql
-- 将现有 memories 表数据迁移到 semantic_memory
INSERT INTO semantic_memory (entity_id, memory_type, content, created_at)
SELECT 
    metadata->>'npc' as entity_id,
    'dialogue' as memory_type,
    content,
    created_at
FROM memories;
```

### 5.3 配置迁移
- 将 `.env` 中的配置迁移到 `config.yaml`
- 支持多环境（dev/prod/test）

---

## 6. 实施路线图

### 阶段 1: 基础设施 (Week 1)
- [ ] 创建新的目录结构
- [ ] 实现 `Neo4jConnector` (从 `GraphClient` 重构)
- [ ] 实现 `PostgresConnector` (从 `VectorClient` 扩展)
- [ ] 创建 SQL Schema (event_ledger, semantic_memory)
- [ ] 设置测试环境

### 阶段 2: Kernel 核心 (Week 2)
- [ ] 实现 `ObjectManager` (通用对象 CRUD)
- [ ] 实现 `RuleEngine` (多模态存储路由)
- [ ] 实现新的 `ActionDriver` (Validation→Rules闭环)
- [ ] 编写单元测试

### 阶段 3: Ontology 层 (Week 3)
- [ ] 设计 Ontology JSON Schema
- [ ] 实现 `OntologyLoader`
- [ ] 迁移现有 Action 到 JSON
- [ ] 创建游戏 Ontology 包

### 阶段 4: Synapser (Week 4)
- [ ] 实现 `Synapser` 意图解析器
- [ ] 迁移 LLM Engine 功能
- [ ] 实现 Synapser Patterns
- [ ] 集成测试

### 阶段 5: 应用层迁移 (Week 5)
- [ ] 重构 `main.py` 为 Game 应用
- [ ] 实现新的游戏主循环
- [ ] 集成测试 (端到端)
- [ ] 性能优化

### 阶段 6: 清理与文档 (Week 6)
- [ ] 删除旧代码
- [ ] 更新文档
- [ ] 编写迁移指南
- [ ] 发布 v0.4

---

## 7. 风险评估

### 高风险
- **数据兼容性**: Postgres Schema 变更需要数据迁移
- **性能退化**: 新增 Validation 层可能增加延迟

### 中风险
- **学习成本**: 团队需要理解新架构
- **测试覆盖**: 需要大量回归测试

### 缓解措施
- 保留 v0.3 分支作为备份
- 每个阶段都有回滚方案
- 充分的单元测试和集成测试

---

## 8. 成功标准

- [ ] 所有现有功能正常工作
- [ ] Action 完全由 JSON 定义，无需修改代码
- [ ] 新增 Action 只需修改 JSON，5分钟内生效
- [ ] Validation → Rules 闭环正常工作
- [ ] 事件账本记录所有操作
- [ ] 语义记忆支持向量检索
- [ ] 性能不低于 v0.3

---

## 9. 参考资源

- Genesis 架构文档: `E:/Documents/Genesis/docs/ARCHITECTURE.md`
- Genesis ActionDriver: `E:/Documents/Genesis/genesis/kernel/action_driver.py`
- Palantir Foundry 模式: Operational Closure, Ontology Model
- 当前项目架构: `E:/Documents/MyGame/docs/` (待创建)

---

**文档版本**: v0.1  
**创建日期**: 2026-02-02  
**作者**: Claude  
**评审状态**: 待评审
