<!DOCTYPE html>
<html lang="zh-CN" x-data="{ isDirty: false, sidebarCollapsed: false, bottomPanelOpen: false }" 
      @htmx:before-request="if(isDirty &amp;&amp; !confirm('有未保存的更改，确定要离开吗？')) event.preventDefault()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genesis Forge Studio - {{ title if title else '可视化仿真世界构建平台' }}</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'studio-bg': '#0f172a',
                        'studio-sidebar': '#1e293b',
                        'studio-panel': '#334155',
                        'studio-border': '#475569',
                        'studio-text': '#f1f5f9',
                        'studio-text-secondary': '#94a3b8',
                        'studio-accent': '#3b82f6',
                        'studio-success': '#10b981',
                        'studio-warning': '#f59e0b',
                        'studio-error': '#ef4444'
                    },
                    fontFamily: {
                        'mono': ['JetBrains Mono', 'Monaco', 'Consolas', 'monospace']
                    }
                }
            }
        }
    </script>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10" integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/sse.js"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        // Alpine.js 调试
        document.addEventListener('alpine:init', () => {
            console.log('Alpine.js initialized');
        });
        
        document.addEventListener('alpine:initialized', () => {
            console.log('Alpine.js components initialized');
        });
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Monaco Editor Loader -->
    <script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>
    
    <!-- Cytoscape.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    
    <!-- NProgress (加载进度条) -->
    <script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.css">
    
    <style>
        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        
        /* 拖拽样式 */
        .draggable {
            cursor: grab;
        }
        .draggable:active {
            cursor: grabbing;
        }
        
        /* 代码编辑器样式 */
        .monaco-editor {
            border-radius: 0.375rem;
            overflow: hidden;
        }
        
        /* 图谱容器 */
        .cy-container {
            border-radius: 0.375rem;
            overflow: hidden;
        }
        
        /* 动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.2s ease-out;
        }
        
        /* 按钮样式 */
        .btn {
            @apply px-4 py-2 rounded-lg font-medium transition-colors duration-200;
        }
        .btn-primary {
            @apply bg-studio-accent hover:bg-blue-600 text-white;
        }
        .btn-secondary {
            @apply bg-studio-panel hover:bg-slate-600 text-studio-text;
        }
        .btn-success {
            @apply bg-studio-success hover:bg-emerald-600 text-white;
        }
        .btn-warning {
            @apply bg-studio-warning hover:bg-amber-600 text-white;
        }
        .btn-error {
            @apply bg-studio-error hover:bg-red-600 text-white;
        }
        
        /* 图标按钮 */
        .btn-icon {
            @apply p-2 rounded-lg hover:bg-studio-panel transition-colors duration-200;
        }
        
        /* 标签页样式 */
        .tab-active {
            @apply border-b-2 border-studio-accent text-studio-accent;
        }
        
        /* 状态指示器 */
        .status-dot {
            @apply w-2 h-2 rounded-full;
        }
        .status-dot-success {
            @apply bg-studio-success;
        }
        .status-dot-warning {
            @apply bg-studio-warning;
        }
        .status-dot-error {
            @apply bg-studio-error;
        }
    </style>
</head>
<body class="bg-studio-bg text-studio-text h-screen overflow-hidden" hx-boost="true">
    
    <!-- 顶部进度条 -->
    <div id="nprogress-container"></div>
    
    <!-- 全局通知容器 -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
    
    <!-- 主应用容器 -->
    <div class="flex flex-col h-screen">
        {% block content %}{% endblock %}
    </div>
    
    <!-- 全局脚本 -->
    <script>
        // 配置HTMX
        htmx.config.useTemplateFragments = true;
        
        // 显示加载进度条
        document.body.addEventListener('htmx:beforeRequest', function(evt) {
            NProgress.start();
        });
        
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            NProgress.done();
        });
        
        // 显示Toast通知
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const typeConfig = {
                info: { icon: 'info-circle', color: 'blue' },
                success: { icon: 'check-circle', color: 'green' },
                warning: { icon: 'exclamation-triangle', color: 'yellow' },
                error: { icon: 'exclamation-circle', color: 'red' }
            };
            
            const config = typeConfig[type];
            
            toast.className = `px-4 py-3 rounded-lg shadow-lg animate-fadeIn bg-${config.color}-900 border border-${config.color}-700 text-${config.color}-300`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${config.icon} mr-3"></i>
                    <span>${message}</span>
                </div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }
        
        // 全局事件监听
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Genesis Forge Studio loaded');
            
            // 监听脏数据状态变化
            document.body.addEventListener('dirty-state-changed', function(evt) {
                const isDirty = evt.detail.isDirty;
                Alpine.store('app').isDirty = isDirty;
                
                // 更新保存按钮状态
                const saveBtn = document.querySelector('[data-save-button]');
                if (saveBtn) {
                    if (isDirty) {
                        saveBtn.classList.add('btn-warning');
                        saveBtn.classList.remove('btn-secondary');
                        saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>保存*';
                    } else {
                        saveBtn.classList.remove('btn-warning');
                        saveBtn.classList.add('btn-secondary');
                        saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>保存';
                    }
                }
            });
            
            // 监听验证错误
            document.body.addEventListener('validation-error', function(evt) {
                const errors = evt.detail.errors;
                showToast(`发现 ${errors.length} 个验证错误`, 'error');
                
                // 自动打开底部面板
                Alpine.store('app').bottomPanelOpen = true;
                htmx.trigger('#validation-tab', 'click');
            });
            
            // 监听保存成功
            document.body.addEventListener('save-success', function(evt) {
                showToast('保存成功', 'success');
                document.body.dispatchEvent(new CustomEvent('dirty-state-changed', {
                    detail: { isDirty: false }
                }));
            });
        });
        
        // 处理命令输入
        function handleCommand(cmd) {
            if (cmd.startsWith('>')) {
                const command = cmd.substring(1).trim().toLowerCase();
                
                switch(command) {
                    case 'reload':
                        htmx.ajax('GET', '/api/reload', '#main-stage');
                        showToast('重新加载中...', 'info');
                        break;
                    case 'validate':
                        htmx.ajax('POST', '/api/validate', '#validation-results');
                        showToast('正在验证...', 'info');
                        break;
                    case 'clear':
                        const consoleOutput = document.getElementById('console-output');
                        if (consoleOutput) {
                            consoleOutput.innerHTML = '<div class="text-studio-text-secondary">控制台已清空</div>';
                        }
                        showToast('控制台已清空', 'success');
                        break;
                    default:
                        showToast(`未知命令: ${command}`, 'warning');
                }
                
                // 清空输入框
                event.target.value = '';
            }
        }
        
        // 全局Alpine store
        document.addEventListener('alpine:init', () => {
            Alpine.store('app', {
                isDirty: false,
                sidebarCollapsed: false,
                bottomPanelOpen: false,
                activeTab: 'editor',
                currentFile: null,
                domain: '{{ current_domain if current_domain else "supply_chain" }}'
            });
        });
    </script>
    
    {% block scripts %}{% endblock %}
    
    <!-- 项目脚本 -->
    <script src="{{ url_for('static', filename='js/studio.js') }}"></script>
    <script src="{{ url_for('static', filename='js/alpine-helpers.js') }}"></script>
    <script src="{{ url_for('static', filename='js/lazy-loader.js') }}"></script>
</body>
</html>